---
title: "MUSA508_Final_Project"
output: html_document
---

# Setup
```{r setup_13, cache=TRUE, message=FALSE}
library(tidyverse)
library(sf)
library(lubridate)
library(tigris)
library(tidycensus)
library(viridis)
library(riem)
library(gridExtra)
library(knitr)
library(kableExtra)
library(RSocrata)

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.2),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

palette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4 <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette2 <- c("#6baed6","#08519c")
```

```{r load_api_key, message = FALSE}
# Load API key
census_api_key("d8b938a81d19a2811d021f339295fbf6135f7d36", overwrite = TRUE)
```

```{r load_data}
# Read in the data with RSocrata package
inspections <- read.socrata(
  "https://data.cityofchicago.org/resource/4ijn-s7e5.json",
  app_token = "soPSENlY4ttB95Y2PJMQLdLQL",
  email     = "willi2eh@upenn.edu",
  password  = "Triscuit3!"
)

# Convert to sf object
# Filter for only restaurants that are in business
inspections <- st_as_sf(inspections, coords = c("latitude", "longitude"), 
                 crs = 4326, agr = "constant", na.fail=FALSE) %>%
   st_transform('ESRI:102271') %>%
  filter(results != "Out of Business") %>%
  filter(results != "Not Ready") %>%
  filter(facility_type == "Restaurant")

```

```{r feature_engineering, warning=FALSE}

# results_numeric
# Outcome variable recoded to numeric binary variable: Fail inspection = 1 & Pass inspection = 0
# If no entry, but violation -> fail
# If no entry, but no violations -> pass
# If pass with conditions -> pass

inspections <- inspections %>%
  mutate(results_numeric = ifelse(inspections$results == "Fail", 1, ifelse(((inspections$results == "No Entry")&(!is.na(inspections$violations))), 1, 0)))

# violations_count
# This code counts the number of times the character | is used (this separates the violations) and adds 1 (because there isn't one in front of the first)
library(stringr)
inspections <- inspections %>%
  mutate(violations_count = str_count(inspections$violations, coll("| "))) 
inspections <- inspections %>%
  mutate(violations_count = ifelse(!is.na(inspections$violations_count), inspections$violations_count + 1, 0))

# Time bins - week & day of the week
inspections <- inspections %>%
  mutate(week = week(inspection_date),
         dotw = wday(inspection_date, label=TRUE))

# Create feature for # of previous inspections
inspections <- inspections %>%
  arrange(inspection_date) %>%
   group_by(dba_name) %>%
   mutate(inspectionCount = row_number() - 1L) %>%
   ungroup()

# Create feature for how many previous inspections they have failed
# https://stackoverflow.com/questions/43957453/r-increasing-variable-based-on-previous-occurrences 
inspections <- inspections %>%
  arrange(dba_name, inspection_date) %>%
  group_by(dba_name) %>%
  mutate(total_inspect = 1:n()) %>%
  # Create a column showing fail_result, fail is 1, pass is 0
  mutate(fail_result = ifelse(results == "Fail", 1, 0)) %>%
  # Calculate the cumulative sum of fail_result
  mutate(failed_inspect = cumsum(fail_result)) %>%
  # Remove fail_result
  select(-fail_result) %>%
  # Sort the data frame by Date
  arrange(inspection_date)

inspections <- inspections %>%
  mutate(past_inspect = ifelse(total_inspect == 0, 0, total_inspect - 1)) %>%
  mutate(past_failed_inspect = ifelse(results == "Fail" & failed_inspect != 0, 
                                      failed_inspect - 1,
                                      failed_inspect)) %>%
  select(-total_inspect, -failed_inspect)

# Subset for inspections in 2017 
# We will estimate a model using inspection data from 2017 to predict for 2018
inspections17 <- inspections %>%
   dplyr::filter((inspection_date > as.POSIXct("2017-01-01")) & (inspection_date < as.POSIXct("2018-01-01")))

```

```{r get_census, message=FALSE, warning=FALSE, cache=TRUE, results = 'hide'}
## change year???
chicagoCensus <- 
  get_acs(geography = "tract", 
          variables = c("B01003_001", "B19013_001", 
                        "B02001_002", "B08013_001",
                        "B08012_001", "B08301_001", 
                        "B08301_010", "B01002_001"), 
          year = 2017, 
          state = "IL", 
          geometry = TRUE, 
          county=c("Cook"),
          output = "wide") %>%
  rename(Total_Pop =  B01003_001E,
         Med_Inc = B19013_001E,
         Med_Age = B01002_001E,
         White_Pop = B02001_002E,
         Travel_Time = B08013_001E,
         Num_Commuters = B08012_001E,
         Means_of_Transport = B08301_001E,
         Total_Public_Trans = B08301_010E) %>%
  select(Total_Pop, Med_Inc, White_Pop, Travel_Time,
         Means_of_Transport, Total_Public_Trans,
         Med_Age,
         GEOID, geometry) %>%
  mutate(Percent_White = White_Pop / Total_Pop,
         Mean_Commute_Time = Travel_Time / Total_Public_Trans,
         Percent_Taking_Public_Trans = Total_Public_Trans / Means_of_Transport)

```

```{r extract_geometries, cache = TRUE}
chicagoTracts <- 
  chicagoCensus %>%
  as.data.frame() %>%
  distinct(GEOID, .keep_all = TRUE) %>%
  select(GEOID, geometry) %>% 
  st_sf 

inspections <- inspections %>% st_transform(4326) 

```

```{r add_census_tracts, cache = TRUE, message = FALSE, warning = FALSE}
dat_census <- st_join(inspections17 %>% 
          filter(is.na(location.latitude) == FALSE &
                   is.na(location.longitude) == FALSE) %>%
          st_as_sf(., coords = c("location.longitude", "location.latitude"), crs = 4326),
        chicagoTracts %>%
          st_transform(crs=4326),
        join=st_intersects,
              left = TRUE) %>%
  rename(Origin.Tract = GEOID) %>%
  mutate(location.longitude = unlist(map(geometry, 1)),
         location.latitude = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  select(-geometry)
 
```

```{r import_weather, message = FALSE, warning = FALSE, cache = TRUE}
weather.Panel <- 
  riem_measures(station = "ORD", date_start = "2017-01-01", date_end = "2017-12-31") %>%
  dplyr::select(valid, tmpf, p01i, sknt)%>%
  replace(is.na(.), 0) %>%
    mutate(inspection_date = as.Date(ymd_h(substr(valid,1,13)))) %>%
    mutate(week = week(inspection_date),
           dotw = wday(inspection_date, label=TRUE)) %>%
    group_by(inspection_date) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))

glimpse(weather.Panel)
```

```{r plot_weather, catche = TRUE}
grid.arrange(
  ggplot(weather.Panel, aes(inspection_date,Precipitation)) + geom_line() + 
  labs(title="Percipitation", x="Day", y="Perecipitation") + plotTheme,
  ggplot(weather.Panel, aes(inspection_date,Wind_Speed)) + geom_line() + 
    labs(title="Wind Speed", x="Day", y="Wind Speed") + plotTheme,
  ggplot(weather.Panel, aes(inspection_date,Temperature)) + geom_line() + 
    labs(title="Temperature", x="Day", y="Temperature") + plotTheme,
  top="Weather Data - Chicago ORD - 2017")
```

```{r weather_plot, cache = TRUE}
ggplot(dat_census %>%
         group_by(inspection_date) %>%
         tally())+
  geom_line(aes(x = inspection_date, y = n))+
  labs(title="Inspections per day in Chicago, May, 2018",
       x="Date", 
       y="Number of Inspections")+
  plotTheme
```

